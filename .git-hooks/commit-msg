#!/bin/sh

# Git commit-msg hook to prevent Claude attribution in commit messages
# This is a shell script version that works without Node.js

if [ -z "$1" ]; then
    echo "‚ùå Error: No commit message file provided"
    exit 1
fi

COMMIT_MSG_FILE="$1"

if [ ! -f "$COMMIT_MSG_FILE" ]; then
    echo "‚ùå Error: Commit message file not found: $COMMIT_MSG_FILE"
    exit 1
fi

# Read the commit message
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Define patterns to detect Claude attribution (using grep -E for extended regex)
CLAUDE_PATTERNS="ü§ñ Generated with.*Claude|Generated with.*Claude Code|Co-Authored-By: Claude|claude\.com/claude-code|@anthropic\.com|Claude Code.*anthropic|Generated with \[Claude Code\]|\[Claude Code\]\(https://claude\.com/claude-code\)"

# Colors for console output
RED='\033[31m'
YELLOW='\033[33m'
GREEN='\033[32m'
RESET='\033[0m'

# Check for Claude attribution patterns
if echo "$COMMIT_MSG" | grep -iE "$CLAUDE_PATTERNS" >/dev/null 2>&1; then
    FOUND_ATTRIBUTION=true
    MATCH=$(echo "$COMMIT_MSG" | grep -iE "$CLAUDE_PATTERNS" | head -1)
else
    FOUND_ATTRIBUTION=false
fi

if [ "$FOUND_ATTRIBUTION" = true ]; then
    echo "${RED}‚ùå COMMIT REJECTED${RESET}"
    echo "${YELLOW}‚ö†Ô∏è  Commit message contains Claude attribution.${RESET}"
    echo ""
    echo "Found Claude attribution pattern:"
    echo "  ‚Ä¢ Match: \"$MATCH\""
    echo ""
    echo "Please edit your commit message to remove Claude attribution."
    echo "Use: git commit --amend -m \"your new message\""
    echo ""
    exit 1
fi

echo "${GREEN}‚úÖ Commit message validated - no Claude attribution detected${RESET}"
exit 0